# This compose file is for https://coolify.io/

# Context is set to "." because Coolify copies the compose file to root and runs it from there

# 1. Create a postgres database in coolify. Use Postgres 18. Do not make it public, ideally setup backups.
# Start it, go to "Terminal". Launch into postgres with "psql" and then apply "ALTER SYSTEM SET wal_level = logical;" Restart the database.

# 2. Create deployment using this compose file.
# Go to "Advanced" and check "Connect To Predefined Network"
# Assign domains to port 80 in coolify as follows:
# web => domain.com:80
# powersync => domain.com:80/powersync

# 3. Set ENV
# VITE_DEPLOY_DOMAIN = your "web" domain. Must NOT end with "/". Correct example: "https://tyl.illkle.com".
# BETTER_AUTH_SECRET = secret for auth. https://jwtsecrets.com/#generator
# POWERSYNC_PASSWORD = powersync password for postgres database
# DATABASE_URL = postgres database url

# Optional ENV
# RESEND_API_KEY =
# RESEND_FROM_EMAIL =

services:
  init:
    x-exclude-from-hc: true
    build:
      context: .
      dockerfile: ./docker/init.Dockerfile
    environment:
      MIGRATE: true
      DATABASE_URL: ${DATABASE_URL}
      POWERSYNC_PASSWORD: ${POWERSYNC_PASSWORD}
    restart: "no"

  powersync:
    restart: unless-stopped
    build:
      context: .
      dockerfile: ./docker/powersync.Dockerfile
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "fetch('http://localhost:80/probes/liveness').then(r => r.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))",
        ]
      interval: 5s
      timeout: 1s
      retries: 15
    environment:
      PS_DATABASE_URL: ${DATABASE_URL}
      PS_AUTH_DOMAIN: ${VITE_DEPLOY_DOMAIN}/api/auth/jwks
      PS_VITE_DEPLOY_DOMAIN: ${VITE_DEPLOY_DOMAIN}
    depends_on:
      init:
        condition: service_completed_successfully

  web:
    restart: unless-stopped
    build:
      context: .
      dockerfile: ./docker/web.Dockerfile
      args:
        VITE_DEPLOY_DOMAIN: ${VITE_DEPLOY_DOMAIN}
        VITE_PREVIEW_WARNING: ${VITE_PREVIEW_WARNING}
        VITE_POWERSYNC_DOMAIN: ${VITE_DEPLOY_DOMAIN}/powersync
    environment:
      NITRO_PORT: 80
      NODE_ENV: production
      DATABASE_URL: ${DATABASE_URL}
      BETTER_AUTH_SECRET: ${BETTER_AUTH_SECRET}
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "fetch('http://localhost:80/health').then(r => r.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))",
        ]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 5s
    depends_on:
      init:
        condition: service_completed_successfully
      powersync:
        condition: service_healthy
